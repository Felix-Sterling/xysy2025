<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>25届超级蹭饭图</title>
    <script id="mainModule" type="module" src="./assets/index-DxjLUdmo.js"></script>
    <script>
      // 守护脚本：捕获主模块及资源加载错误并在加载成功后自动隐藏 loading（容错静态托管场景）
      (function(){
        const main = document.getElementById('mainModule');
        function report(msg){
          console.error(msg);
          if(window.showError) window.showError(msg);
        }
        if(main){
          main.addEventListener('error', ()=>{
            report('主脚本加载失败：'+main.src);
          });
          main.addEventListener('load', ()=>{
            // 脚本本身已加载，等待应用初始化信号；若未在 3s 内初始化，则尝试隐藏加载层以避免永久白屏
            console.log('主脚本已加载：', main.src);
            let done = false;
            const tryHide = ()=>{
              if(done) return; // already handled
              // 如果 root 中已有子节点，认为应用已挂载
              const root = document.getElementById('root');
              if(root && root.children && root.children.length>0){
                done = true; window.__appInitialized ? window.__appInitialized() : window.hideLoading && window.hideLoading();
                return;
              }
            };
            // 监听一个短超时后再尝试隐藏，避免一直等待
            const t1 = setTimeout(()=>{ tryHide(); }, 3000);
            // 如果应用主动调用 window.__appInitialized，标记为 done
            const orig = window.__appInitialized;
            window.__appInitialized = function(){ done = true; try{ if(orig) orig(); }catch(e){} window.hideLoading && window.hideLoading(); };
          });
        }

        // 给 modulepreload 和 stylesheet 添加 onerror
        document.querySelectorAll('link[rel="modulepreload"],link[rel="stylesheet"]').forEach(lk=>{
          lk.addEventListener('error', ()=>{
            const href = lk.getAttribute('href')||lk.getAttribute('data-href');
            report('静态资源加载失败：'+href);
          });
        });
      })();
    </script>
    <link rel="modulepreload" href="./assets/vendor-CjmK-aEU.js">
    <link rel="modulepreload" href="./assets/utils-Ca6gsgWq.js">
    <link rel="modulepreload" href="./assets/ui-Df3unzsj.js">
    <link rel="stylesheet" href="./assets/index-CrHWLaqy.css">
    <style>
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-text {
        margin-top: 20px;
        font-size: 18px;
        color: #333;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* DevTools 检测弹窗样式（浅红色底色） */
      .f12-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(255, 236, 236, 0.95); /* 浅红色背景 */
        z-index: 10000;
      }
      .f12-box {
        max-width: 720px;
        width: calc(100% - 48px);
        padding: 20px;
        border-radius: 8px;
        background: #fff6f6;
        color: #8b0000;
        text-align: center;
        box-shadow: 0 6px 24px rgba(0,0,0,0.12);
      }
      .f12-id {
        margin-top: 10px;
        background: #fff;
        padding: 8px 10px;
        border-radius: 4px;
        font-family: monospace;
        display: inline-block;
        color: #b30000;
      }
      .f12-copy {
        margin-left: 8px;
        padding: 6px 10px;
        background: #c0392b;
        color: #fff;
        border: 0;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }
      .f12-note {
        margin-top: 10px;
        font-size: 13px;
        color: #5c0000;
      }
    </style>
    <!-- 基础路径，确保在子路径 /xysy2025/ 部署时相对资源能正确解析 -->
    <base href="./">
  </head>
  <body>
    <div id="root"></div>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">正在加载地图数据和录取数据...</div>
    </div>
    <script>
      // 调试用：显示/隐藏加载窗口，以及在白屏时显示错误提示
      (function(){
        const overlay = document.getElementById('loadingOverlay');
        const textEl = overlay && overlay.querySelector('.loading-text');

        function setText(msg){
          if(textEl) textEl.textContent = msg;
        }

        window.hideLoading = function() {
          try{ overlay.style.display = 'none'; }catch(e){}
        };

        window.showLoading = function(msg){
          try{ overlay.style.display = 'flex'; setText(msg||'正在加载地图数据和录取数据...'); }catch(e){}
        };

        window.showError = function(msg){
          try{
            overlay.style.background = 'rgba(255,255,255,0.98)';
            overlay.innerHTML = `
              <div style="max-width:720px;padding:24px;border-radius:8px;text-align:center;color:#333;">
                <h2 style="margin:0 0 12px;color:#c00;">加载失败或应用出错</h2>
                <div style="margin-bottom:12px">${(msg||'发生未知错误，请打开控制台查看错误信息。').replace(/</g,'&lt;')}</div>
                <div style="font-size:13px;color:#666;margin-bottom:12px">建议：按 F12 打开控制台查看详情，或刷新页面 (Ctrl+R)。</div>
                <button id="reloadBtn" style="padding:8px 14px;background:#3498db;color:#fff;border:0;border-radius:4px;cursor:pointer">刷新</button>
              </div>
            `;
            const btn = document.getElementById('reloadBtn');
            if(btn) btn.addEventListener('click',()=>location.reload());
          }catch(e){console.error(e)}
        };

        // 全局错误捕获
        window.addEventListener('error', function(ev){
          console.error('捕获到错误：', ev.error || ev.message || ev);
          window.showError(ev.error && ev.error.stack ? ev.error.stack : ev.message || String(ev));
        });
        window.addEventListener('unhandledrejection', function(ev){
          console.error('未处理的 Promise 异常：', ev.reason);
          window.showError(ev.reason && ev.reason.stack ? ev.reason.stack : String(ev.reason));
        });

        // 检查关键资源是否可访问（可根据需要调整或扩展）
        const resources = [
          './assets/index-DxjLUdmo.js',
          './assets/vendor-CjmK-aEU.js',
          './assets/utils-Ca6gsgWq.js',
          './assets/ui-Df3unzsj.js'
        ];

        async function checkResources(){
          try{
            setText('正在检查前端资源...');
            const checks = await Promise.all(resources.map(async (url)=>{
              try{const r = await fetch(url,{method:'HEAD'});return {url,ok:r.ok,status:r.status};}catch(e){return {url,ok:false,status:0,error:String(e)};}
            }));
            const failed = checks.filter(c=>!c.ok);
            if(failed.length){
              console.warn('部分资源无法访问：', failed);
              window.showError('部分静态资源加载失败：\n' + failed.map(f=>f.url+(f.status?(' (status:'+f.status+')'):'')).join('\n'));
              return false;
            }
            setText('资源检查通过，正在等待应用初始化...');
            return true;
          }catch(e){console.error(e);return false;}
        }

        // 如果 8 秒内没有手动调用 hideLoading 或应用自行移除覆盖层，则展示提示
        let initialized = false;
        function markInitialized(){ initialized = true; window.hideLoading(); }
        window.__appInitialized = markInitialized; // app 可在加载完成后调用 window.__appInitialized()

        (async function(){
          const ok = await checkResources();
          if(!ok) return;

          setTimeout(() => {
            if(!initialized){
              setText('应用尚未完成初始化，若一直停留请打开控制台查看错误。');
              // 继续等待，但提示用户
            }
          }, 8000);
        })();

      })();
    </script>

    <!-- 强化的 DevTools 检测脚本（无“立即跳转”按钮）：
         - 打开 DevTools 时将该设备 ID 写入本地黑名单（localStorage）并重定向到 window.f12RedirectUrl（替换历史记录）
         - 页面加载时若本地黑名单包含当前设备 ID，则立即重定向
         - 弹窗会显示设备 ID，提供复制按钮，便于你在服务器或管理面板中记录/全网拉黑
         配置：在任意脚本中设置 window.f12RedirectUrl = 'https://目标.example'（必填以实现踢出/上报）。
    -->
    <script>
      (function(){
        // 请在部署时把这个全局设置为目标跳转地址，例如：
        // window.f12RedirectUrl = 'https://example.com/blocked';
        window.f12RedirectUrl = window.f12RedirectUrl || '';

        // 设备 id key 和本地黑名单 key
        const DEVICE_ID_KEY = 'xsy_device_id_v1';
        const BANNED_LIST_KEY = 'xsy_banned_devices_v1';

        // 生成/读取设备 ID（对该浏览器实例持久）
        function getDeviceId() {
          try {
            let id = localStorage.getItem(DEVICE_ID_KEY);
            if (id) return id;
            // 优先使用 crypto.randomUUID（现代浏览器）
            if (window.crypto && crypto.randomUUID) {
              id = crypto.randomUUID();
            } else if (window.crypto && crypto.getRandomValues) {
              const arr = new Uint8Array(16);
              crypto.getRandomValues(arr);
              id = Array.from(arr).map(b => ('0' + b.toString(16)).slice(-2)).join('');
            } else {
              id = 'xsy-' + Math.random().toString(36).slice(2, 10);
            }
            localStorage.setItem(DEVICE_ID_KEY, id);
            return id;
          } catch (e) {
            // 如果 localStorage 不可用，退回到一个 ephemeral id（不会持久）
            try { console.error(e); } catch(e) {}
            return 'xsy-ephemeral-' + Date.now();
          }
        }

        function readBannedList() {
          try {
            const raw = localStorage.getItem(BANNED_LIST_KEY);
            if (!raw) return [];
            return JSON.parse(raw) || [];
          } catch (e) {
            return [];
          }
        }
        function writeBannedList(list) {
          try {
            localStorage.setItem(BANNED_LIST_KEY, JSON.stringify(list || []));
          } catch (e) {}
        }
        function isBanned(id) {
          try {
            const list = readBannedList();
            return list.indexOf(id) !== -1;
          } catch (e) { return false; }
        }

        const deviceId = getDeviceId();

        // 如果当前设备已被本地拉黑，立刻重定向（或展示禁止页面）
        function immediateRedirectIfBanned() {
          if (!isBanned(deviceId)) return false;
          const url = (window.f12RedirectUrl || '').toString().trim();
          if (url) {
            // 带上标识，便于服务器端记录
            const target = url + (url.indexOf('?') === -1 ? '?' : '&') + 'banned=1&id=' + encodeURIComponent(deviceId);
            try { location.replace(target); } catch (e) { location.href = target; }
          } else {
            // 如果未配置重定向地址，就显示一个不可关闭的禁止提示
            showOverlay('你的设备已被禁止访问。设备 ID：', true);
          }
          return true;
        }

        // 创建并显示弹窗（含设备 ID 文本和复制按钮，但无跳转按钮）
        function showOverlay(prefixText, persistent) {
          let existing = document.getElementById('f12Overlay');
          if (existing) return existing;
          const overlay = document.createElement('div');
          overlay.className = 'f12-overlay';
          overlay.id = 'f12Overlay';
          overlay.innerHTML = `
            <div class="f12-box" role="dialog" aria-modal="true">
              <h2 style="margin:0 0 12px">检测到窥探天机，正在跳转...</h2>
              <div class="f12-note">${(prefixText || '')}</div>
              <div style="margin-top:8px">
                <span class="f12-id" id="f12DeviceId">${deviceId}</span>
                <button class="f12-copy" id="f12CopyBtn">复制 ID</button>
              </div>
              <div class="f12-note" style="margin-top:12px">该设备已被移出。若需复审请联系管理员并提供设备 ID。</div>
            </div>
          `;
          document.body.appendChild(overlay);
          overlay.style.display = 'flex';

          const copyBtn = document.getElementById('f12CopyBtn');
          if (copyBtn) {
            copyBtn.addEventListener('click', function() {
              try {
                const idEl = document.getElementById('f12DeviceId');
                const text = idEl ? idEl.textContent || idEl.innerText : deviceId;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(text).then(()=> {
                    copyBtn.textContent = '已复制';
                    setTimeout(()=>copyBtn.textContent = '复制 ID', 1500);
                  }).catch(()=>{
                    fallbackCopy(text, copyBtn);
                  });
                } else {
                  fallbackCopy(text, copyBtn);
                }
              } catch (e) { /* ignore */ }
            }, {passive:true});
          }

          function fallbackCopy(text, btn) {
            try {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.position = 'fixed';
              ta.style.left = '-9999px';
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
              if (btn) { btn.textContent = '已复制'; setTimeout(()=>btn.textContent = '复制 ID', 1500); }
            } catch (e) {}
          }

          // 如果 persistent=true，不自动关闭
          if (!persistent) {
            // 自动隐藏 overlay（在跳转之前）
            setTimeout(()=>{
              try { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); } catch(e) {}
            }, 900);
          }

          return overlay;
        }

        // 将设备 id 写入本地黑名单并重定向
        function banAndRedirect(reason) {
          try {
            const list = readBannedList();
            if (list.indexOf(deviceId) === -1) {
              list.push(deviceId);
              writeBannedList(list);
            }
          } catch (e) { /* ignore */ }

          // 显示 overlay（持久），然后重定向（若配置）
          showOverlay('检测到窥探天机，设备已被拉黑。设备 ID：', true);

          const url = (window.f12RedirectUrl || '').toString().trim();
          if (url) {
            const target = url + (url.indexOf('?') === -1 ? '?' : '&') + 'banned=1&id=' + encodeURIComponent(deviceId) + '&reason=' + encodeURIComponent(reason || 'devtools');
            // 使用 replace 避免留下历史记录
            try { setTimeout(()=>{ location.replace(target); }, 700); } catch (e) { setTimeout(()=>{ location.href = target; }, 700); }
          }
        }

        // 检测方法：窗口尺寸差异（用于 docked DevTools）
        function checkByResize() {
          try {
            const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
            const heightDiff = Math.abs(window.outerHeight - window.innerHeight);
            // 较小屏幕上 threshold 可以相应减小
            const THRESHOLD = Math.max(160, Math.min(300, Math.floor(Math.min(window.outerWidth, window.outerHeight) * 0.15)));
            return (widthDiff > THRESHOLD) || (heightDiff > THRESHOLD);
          } catch (e) {
            return false;
          }
        }

        // 检测方法：console getter 技巧
        function checkByConsoleGetter() {
          try {
            let opened = false;
            const obj = {};
            Object.defineProperty(obj, 'toString', {
              get: function() {
                opened = true;
                return function(){ return ''; };
              }
            });
            // 将对象输出到控制台；打开控制台时某些浏览器会访问 getter
            // 注意：在某些浏览器/环境该技巧可能不起作用，作为辅助检测
            console.log(obj);
            return opened;
          } catch (e) {
            return false;
          }
        }

        // 监听按键组合（F12 / Ctrl+Shift+I/J/C）
        window.addEventListener('keydown', function(e){
          try {
            const key = (e.key || '').toLowerCase();
            const code = e.keyCode || e.which || 0;
            if (
                key === 'f12' || code === 123 ||
                (e.ctrlKey && e.shiftKey && (key === 'i' || key === 'j' || key === 'c'))
            ){
              try { e.preventDefault(); } catch (err) {}
              banAndRedirect('keyboard');
            }
          } catch (e){}
        }, {capture:true, passive:false});

        // 监听 resize：可能是 docked DevTools 打开
        let lastResizeCheck = 0;
        window.addEventListener('resize', function(){
          try{
            const now = Date.now();
            // 限制频率
            if (now - lastResizeCheck < 200) return;
            lastResizeCheck = now;
            if (checkByResize()) banAndRedirect('resize-event');
          }catch(e){}
        });

        // 周期性检测（综合 console getter + resize）
        const POLL_INTERVAL = 700;
        const poller = setInterval(function(){
          try {
            if (checkByResize()) { banAndRedirect('periodic-resize'); return; }
            if (checkByConsoleGetter()) { banAndRedirect('console-getter'); return; }
          } catch (e) {
            // ignore
          }
        }, POLL_INTERVAL);

        // 在页面载入时先检查本地黑名单
        try { immediateRedirectIfBanned(); } catch (e){}

        // 导出一个手动触发接口（供内部管理/测试使用）
        window.triggerDevtoolsProtect = function(){ banAndRedirect('manual'); };

        // 页面卸载前清理
        window.addEventListener('beforeunload', function(){
          try { clearInterval(poller); } catch(e){}
        });
      })();
    </script>
  </body>
</html>
